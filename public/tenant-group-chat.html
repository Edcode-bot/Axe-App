<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tenant Group Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    #messages {
      max-height: 400px;
      overflow-y: auto;
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 0.5rem;
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <h4>Tenant Group Chat</h4>

    <!-- Messages -->
    <div id="messages" class="mb-3"></div>

    <!-- File Upload Form -->
    <form id="uploadForm" enctype="multipart/form-data">
      <input type="file" name="file" class="form-control mb-2" required>
      <button type="submit" class="btn btn-secondary w-100 mb-3">ðŸ“Ž Upload File</button>
    </form>

    <!-- Text Message Form -->
    <form id="chatForm">
      <input type="text" id="messageInput" class="form-control mb-2" placeholder="Type a message..." autocomplete="off">
      <emoji-picker id="emojiPicker" style="width: 100%; display: none;"></emoji-picker>
<button class="btn btn-sm btn-light w-100 mb-3" type="button" onclick="toggleEmojiPicker()">ðŸ˜€ Emoji</button>
      <button class="btn btn-primary w-100" type="submit">Send</button>
    </form>
  </div>

  <script>
    const socket = io();
    const senderId = sessionStorage.getItem("userId");
    const propertyId = sessionStorage.getItem("propertyId");

    const messages = document.getElementById('messages');

    // Join group room
    socket.emit('joinGroup', { propertyId });

    // Load chat history
    fetch('/group-messages?property=' + propertyId)
      .then(res => res.json())
      .then(data => {
        data.forEach(m => {
          const div = document.createElement('div');
          const isFile = m.content.includes('/uploads/');
          div.innerHTML = isFile
            ? `<strong>${m.sender === senderId ? 'You' : 'Tenant'}:</strong> <a href="${m.content}" target="_blank">ðŸ“Ž View File</a>`
            : `<strong>${m.sender === senderId ? 'You' : 'Tenant'}:</strong> ${m.content}`;
          messages.appendChild(div);
        });
        messages.scrollTop = messages.scrollHeight;
      });

    // Text message submit
    document.getElementById('chatForm').addEventListener('submit', e => {
      e.preventDefault();
      const content = document.getElementById('messageInput').value;
      if (!content) return;
      socket.emit('sendGroupMessage', { senderId, propertyId, content });
      document.getElementById('messageInput').value = '';
    });

    // File upload
    document.getElementById('uploadForm').addEventListener('submit', async e => {
      e.preventDefault();
      const formData = new FormData(e.target);
      formData.append('senderId', senderId);
      formData.append('propertyId', propertyId);

      const res = await fetch('/upload-file', {
        method: 'POST',
        body: formData
      });

      if (res.ok) document.getElementById('uploadForm').reset();
    });

    // Display incoming messages
    socket.on('newGroupMessage', data => {
      const div = document.createElement('div');
      const isFile = data.isFile || data.content.includes('/uploads/');
      div.innerHTML = isFile
        ? `<strong>${data.senderId === senderId ? 'You' : 'Tenant'}:</strong> <a href="${data.content}" target="_blank">ðŸ“Ž View File</a>`
        : `<strong>${data.senderId === senderId ? 'You' : 'Tenant'}:</strong> ${data.content}`;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    });

  const emojiPicker = document.getElementById('emojiPicker');
  const messageInput = document.getElementById('messageInput');

  function toggleEmojiPicker() {
    emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'block' : 'none';
  }

  emojiPicker.addEventListener('emoji-click', event => {
    messageInput.value += event.detail.unicode;
    emojiPicker.style.display = 'none';
    messageInput.focus();
  });

  </script>
</body>
</html>
